# Dockerfile para Backend Spliton - Railway Deploy com Migrations AutomÃ¡ticas
FROM node:20-alpine

# Instalar dependÃªncias necessÃ¡rias para Prisma com PostgreSQL
RUN apk add --no-cache openssl

# Criar diretÃ³rio da aplicaÃ§Ã£o
WORKDIR /app

# Copiar package.json do backend
COPY backend/package.json ./

# Instalar todas as dependÃªncias (incluindo dev dependencies para build)
RUN npm install

# Copiar cÃ³digo fonte do backend (incluindo prisma)
COPY backend/ ./

# Gerar Prisma Client
RUN npx prisma generate

# Build da aplicaÃ§Ã£o
RUN npm run build

# Tornar o script de inicializaÃ§Ã£o executÃ¡vel
RUN chmod +x scripts/start.sh

# Verificar se o script existe
RUN ls -la scripts/start.sh

# Expor porta
EXPOSE 3000

# VariÃ¡veis de ambiente
ENV NODE_ENV=production
ENV PORT=3000

# âœ… NOVO: Comando que executa migrations e inicia a aplicaÃ§Ã£o
# Fallback: se o script falhar, executa diretamente
CMD ["sh", "-c", "echo 'ğŸ”„ Executando migrations...' && npx prisma migrate deploy && echo 'ğŸš€ Iniciando aplicaÃ§Ã£o...' && node dist/src/main.js"]
